<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rengashotelli ‚Äì Web</title>
  <style>
    :root{
      --bg:#edf2f7; --card:#fff; --text:#1f2937; --sub:#4b5563;
      --border:#d7dde6; --primary:#0E7AFE; --accent:#FF9F1C;
      --danger:#b00020; --ok:#1b5e20; --shadow:0 1px 0 rgba(0,0,0,.03);
      --r:14px;
      --today:#fff6e5;
      --now:#e8f1ff;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    .wrap{max-width:1250px; margin:0 auto; padding:16px;}
    .topbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:10px;}
    .brand{font-size:30px; font-weight:900;}
    .muted{color:var(--sub)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--r); padding:12px; box-shadow:var(--shadow); margin:10px 0;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    input, button, select, textarea{
      font-size:15px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff;
    }
    textarea{min-height:84px; width:100%; resize:vertical;}
    input{min-width:220px}
    button{cursor:pointer}
    button.primary{background:var(--primary); color:#fff; border-color:transparent;}
    button.danger{border-color:#f1b7bf; color:var(--danger); background:#fff;}
    button.ghost{background:#fff;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px;}
    .pill.blue{border-color:rgba(14,122,254,.25); background:rgba(14,122,254,.06);}
    .pill.orange{border-color:rgba(255,159,28,.35); background:rgba(255,159,28,.10);}
    .status{padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff;}
    .status.ok{border-color:#cfe8d3; color:var(--ok);}
    .status.err{border-color:#f1b7bf; color:var(--danger);}
    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff;}
    .tab.active{border-color:rgba(14,122,254,.45);}
    .small{font-size:13px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    @media (max-width: 980px){ .grid2,.grid3{grid-template-columns:1fr;} input{min-width:unset; width:100%;} }

    table{width:100%; border-collapse:separate; border-spacing:0; border-radius:12px; overflow:hidden;}
    th, td{border:1px solid var(--border); padding:10px; text-align:left; vertical-align:top; background:#fff;}
    thead th{background:#f6f7fb;}
    thead th{position:sticky; top:0; z-index:3;}
    thead tr:nth-child(2) th{top:44px; z-index:3;}
    tr:hover td{background:#fafbff;}
    .todayCol{background:var(--today)!important;}
    .nowRow td{background:var(--now)!important;}
    .calWrap{overflow:auto; max-height:70vh; margin-top:10px; border-radius:12px;}
    .calTime{min-width:84px; position:sticky; left:0; z-index:4; background:#f6f7fb;}
    .calTimeCell{position:sticky; left:0; z-index:2; background:#fff;}
    .calCell{min-width:170px;}
    .hint{font-size:12px; color:var(--sub); margin-top:6px;}
    .k{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#fff;}

    /* modal */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:14px;}
    .overlay.show{display:flex;}
    .modal{width:min(860px, 100%); background:#fff; border-radius:16px; border:1px solid var(--border); padding:12px;}
    .modal h3{margin:6px 0 10px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brand">Rengashotelli</div>
        <div class="muted small">Asiakkaat ‚Ä¢ Sis√§√§notto ‚Ä¢ Renkaat ‚Ä¢ Kalenteri (2 paikkaa) ‚Ä¢ Asetukset</div>
      </div>

      <div class="row">
        <input id="hotelCode" placeholder="hotel_code (esim. Testihotelli)" />
        <button id="btnReload" class="primary">P√§ivit√§</button>
        <button id="btnLogout">Ulos</button>
      </div>
    </div>

    <div id="status" class="card"><div class="status">Alustetaan‚Ä¶</div></div>

    <div id="authCard" class="card" style="display:none;">
      <h3>Kirjaudu</h3>
      <div class="row">
        <input id="email" type="email" placeholder="S√§hk√∂posti" />
        <input id="password" type="password" placeholder="Salasana" />
        <button id="btnLogin" class="primary">Kirjaudu</button>
        <button id="btnSignup" class="ghost">Rekister√∂i</button>
      </div>
      <div id="authMsg" class="status err" style="display:none; margin-top:10px;"></div>
    </div>

    <div id="appCard" style="display:none;">
      <div class="card">
        <div class="tabs">
          <button class="tab active" data-view="customers">Asiakkaat</button>
          <button class="tab" data-view="intake">Sis√§√§notto</button>
          <button class="tab" data-view="tires">Renkaat</button>
          <button class="tab" data-view="calendar">Kalenteri</button>
          <button class="tab" data-view="settings">Asetukset</button>
          <span class="pill" id="userPill"></span>
        </div>
        <div class="hint">Click = avaa ‚Ä¢ Double = muokkaa ‚Ä¢ (mobiili) pitk√§ll√§ painalluksella saat saman kuin click.</div>
      </div>

      <!-- Customers -->
      <div id="view_customers" class="card">
        <div class="row">
          <div>
            <div class="small muted">customers</div>
            <div style="font-size:22px; font-weight:900;">Asiakkaat</div>
          </div>
          <div style="margin-left:auto" class="row">
            <input id="custSearch" placeholder="Haku" />
            <button id="custAdd" class="primary">Lis√§√§</button>
            <button id="custRefresh">P√§ivit√§</button>
          </div>
        </div>
        <div style="overflow:auto; max-height:65vh; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Nimi</th><th>Puhelin</th><th>S√§hk√∂posti</th><th>Luotu</th><th>Poistettu</th>
              </tr>
            </thead>
            <tbody id="custTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Intake -->
      <div id="view_intake" class="card" style="display:none;">
        <div class="row">
          <div>
            <div class="small muted">Uusi rengas sis√§√§n varastoon</div>
            <div style="font-size:22px; font-weight:900;">Sis√§√§notto</div>
          </div>
          <div style="margin-left:auto" class="row">
            <button id="intakeRefresh">P√§ivit√§ vapaat hyllyt</button>
          </div>
        </div>

        <div class="hint">Valitse ensin asiakas (jos olemassa) ‚Üí t√§ytt√§√§ nimen/puhelimen/s√§hk√∂postin. T√§yt√§ vain rekisteri ja valitse vapaa hylly.</div>

        <div class="grid2" style="margin-top:10px;">
          <div style="grid-column:1/-1">
            <div class="small muted">Valitse asiakas</div>
            <input id="in_customer_pick" list="custList" placeholder="Kirjoita nimi / puhelin / s√§hk√∂posti‚Ä¶" />
            <datalist id="custList"></datalist>
          </div>

          <div><div class="small muted">Nimi</div><input id="in_nimi"></div>
          <div><div class="small muted">Puhelin</div><input id="in_puhelin"></div>
          <div><div class="small muted">S√§hk√∂posti</div><input id="in_sahkoposti"></div>
          <div><div class="small muted">Rekisteri (t√§yt√§ t√§m√§)</div><input id="in_rekisteri" placeholder="ABC-123"></div>

          <div>
            <div class="small muted">Hyllypaikka (vain vapaat, j√§rjestys 1A1‚Ä¶)</div>
            <select id="in_hyllypaikka"></select>
          </div>
          <div>
            <div class="small muted">Kausimaksu</div>
            <select id="in_maksettu">
              <option value="Maksettu">Maksettu</option>
              <option value="Ei maksettu">Ei maksettu</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="in_save" class="primary">Tallenna sis√§√§notto</button>
          <span class="pill" id="in_today"></span>
          <span class="pill orange" id="in_pick_hint" style="display:none;"></span>
        </div>
      </div>

      <!-- Tires -->
      <div id="view_tires" class="card" style="display:none;">
        <div class="row">
          <div>
            <div class="small muted">tires</div>
            <div style="font-size:22px; font-weight:900;">Renkaat</div>
          </div>
          <div style="margin-left:auto" class="row">
            <input id="tiresSearch" placeholder="Haku (rek/nimi/hylly)" />
            <select id="tiresStatus">
              <option value="">Kaikki tilat</option>
              <option>Varastossa</option>
              <option>Luovutettu</option>
              <option>Poistettu</option>
            </select>
            <button id="tiresRefresh">P√§ivit√§</button>
          </div>
        </div>
        <div style="overflow:auto; max-height:65vh; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Rekisteri</th><th>Nimi</th><th>Puhelin</th><th>Hylly</th><th>Tila</th><th>Sis√§√§n</th><th>Kausimaksu</th>
              </tr>
            </thead>
            <tbody id="tiresTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Calendar -->
      <div id="view_calendar" class="card" style="display:none;">
        <div class="row">
          <div>
            <div class="small muted">appointments + calendar_blocks</div>
            <div style="font-size:22px; font-weight:900;">Kalenteri (2 paikkaa vierekk√§in)</div>
          </div>
          <div style="margin-left:auto" class="row">
            <button id="calToday" class="ghost">T√§m√§ viikko</button>
            <input id="calWeek" type="date" />
            <button id="calNewAppt" class="primary">Uusi varaus</button>
            <button id="calNewBlock">Uusi blokki</button>
            <button id="calRefresh">P√§ivit√§</button>
          </div>
        </div>
        <div class="hint" id="calHint"></div>

        <div class="calWrap">
          <table>
            <thead id="calThead"></thead>
            <tbody id="calTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Settings -->
      <div id="view_settings" class="card" style="display:none;">
        <div class="row">
          <div>
            <div class="small muted">calendar_settings</div>
            <div style="font-size:22px; font-weight:900;">Asetukset</div>
          </div>
          <div style="margin-left:auto" class="row">
            <button id="setSave" class="primary">Tallenna</button>
            <button id="setRefresh">P√§ivit√§</button>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div><div class="small muted">Auki</div><input id="setOpen" placeholder="08:00" /></div>
          <div><div class="small muted">Kiinni</div><input id="setClose" placeholder="17:00" /></div>
          <div><div class="small muted">Slot minutes</div><input id="setSlot" type="number" min="5" step="5" /></div>
          <div><div class="small muted">Timezone</div><input id="setTz" placeholder="Europe/Helsinki" /></div>
          <div>
            <div class="small muted">N√§yt√§ la</div>
            <select id="setSat"><option value="true">true</option><option value="false">false</option></select>
          </div>
          <div>
            <div class="small muted">N√§yt√§ su</div>
            <select id="setSun"><option value="true">true</option><option value="false">false</option></select>
          </div>
        </div>
        <div class="hint">Kalenterin aukiolo + slot-ohjaus tulee t√§st√§.</div>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <div class="row" style="justify-content:space-between;">
        <h3 id="modalTitle" style="margin:0;">Toiminnot</h3>
        <button id="btnClose">Sulje</button>
      </div>

      <div id="modalForm" style="margin-top:10px;">
        <div id="formArea"></div>
        <div class="row" style="margin-top:12px;">
          <button id="formSave" class="primary">Tallenna</button>
          <button id="formDelete" class="danger">Poista</button>
          <button id="formCancel" class="ghost">Peruuta</button>
        </div>
        <div class="hint" id="formHint"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xbxmysfxbkcrjsxjtzkz.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_8e1s0Fj93ydy900tLpAwHQ_BAfVDGUq";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);

    const HOTEL_KEY = "rengashotelli_hotel_code";
    $("hotelCode").value = localStorage.getItem(HOTEL_KEY) || "";
    $("hotelCode").addEventListener("input", () => localStorage.setItem(HOTEL_KEY, $("hotelCode").value.trim()));

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function setStatus(text, kind=""){ $("status").innerHTML = `<div class="status ${kind}">${escapeHtml(text)}</div>`; }
    function isoDate(d){ return new Date(d).toISOString().slice(0,10); }

    // Tabs
    function setActiveView(name){
      document.querySelectorAll(".tab").forEach(b => b.classList.toggle("active", b.getAttribute("data-view") === name));
      ["customers","intake","tires","calendar","settings"].forEach(v => {
        $("view_"+v).style.display = (v===name) ? "" : "none";
      });
    }
    document.querySelectorAll(".tab").forEach(btn => {
      btn.onclick = async () => {
        setActiveView(btn.getAttribute("data-view"));
        await refreshCurrentView();
      };
    });
    async function refreshCurrentView(){
      const v = document.querySelector(".tab.active")?.getAttribute("data-view");
      if(v==="customers") return loadCustomers();
      if(v==="intake") return loadIntake();
      if(v==="tires") return loadTires();
      if(v==="calendar") return loadCalendar();
      if(v==="settings") return loadSettings();
    }
    $("btnReload").onclick = refreshCurrentView;

    // Auth UI
    function showAuth(msg=""){
      $("authCard").style.display = "";
      $("appCard").style.display = "none";
      if(msg){ $("authMsg").style.display=""; $("authMsg").textContent=msg; }
      else { $("authMsg").style.display="none"; $("authMsg").textContent=""; }
    }
    function showApp(user){
      $("authCard").style.display = "none";
      $("appCard").style.display = "";
      $("userPill").textContent = user?.email ?? "kirjautunut";
    }
    $("btnLogin").onclick = async () => {
      const { error } = await supabase.auth.signInWithPassword({ email: $("email").value.trim(), password: $("password").value });
      if(error) return showAuth(error.message);
      await boot();
    };
    $("btnSignup").onclick = async () => {
      const { error } = await supabase.auth.signUp({ email: $("email").value.trim(), password: $("password").value });
      if(error) return showAuth(error.message);
      showAuth("Rekister√∂ity. Tarkista s√§hk√∂posti jos vahvistus on k√§yt√∂ss√§.");
    };
    $("btnLogout").onclick = async () => { await supabase.auth.signOut(); showAuth(); setStatus("Uloskirjattu."); };

    // ===== Modal (edit / add) =====
    const overlay = $("overlay");
    let modalCtx = { table:null, mode:null, row:null }; // mode add/edit
    function openModal(title, hint, html, ctx){
      $("modalTitle").textContent = title;
      $("formHint").textContent = hint || "";
      $("formArea").innerHTML = html || "";
      modalCtx = ctx;
      $("formDelete").style.display = (ctx.mode==="edit") ? "" : "none";
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      $("formArea").innerHTML = "";
      modalCtx = { table:null, mode:null, row:null };
    }
    $("btnClose").onclick = closeModal;
    $("formCancel").onclick = closeModal;
    overlay.addEventListener("click",(e)=>{ if(e.target===overlay) closeModal(); });

    // ===== Customers =====
    let customers = [];
    let customersActive = [];

    async function loadCustomers(){
      const hotel_code = $("hotelCode").value.trim();
      if(!hotel_code){ setStatus("Anna hotel_code.", "err"); return; }
      setStatus("Ladataan asiakkaat‚Ä¶");
      const { data, error } = await supabase
        .from("customers")
        .select("id,nimi,puhelin,sahkoposti,poistettu,created_at")
        .eq("hotel_code", hotel_code)
        .order("created_at",{ascending:false});
      if(error){ setStatus("Customers: "+error.message, "err"); return; }
      customers = data ?? [];
      renderCustomers();
      setStatus("Valmis.", "ok");
    }

    function renderCustomers(){
      const term = $("custSearch").value.trim().toLowerCase();
      const rows = term ? customers.filter(r => JSON.stringify(r).toLowerCase().includes(term)) : customers;
      $("custTbody").innerHTML = rows.map(r => `
        <tr data-id="${r.id}">
          <td><b>${escapeHtml(r.nimi||"")}</b></td>
          <td>${escapeHtml(r.puhelin||"")}</td>
          <td>${escapeHtml(r.sahkoposti||"")}</td>
          <td class="small">${r.created_at ? new Date(r.created_at).toLocaleString("fi-FI") : ""}</td>
          <td class="small">${r.poistettu ? `<span class="pill">kyll√§</span>` : ""}</td>
        </tr>
      `).join("");

      [...$("custTbody").querySelectorAll("tr[data-id]")].forEach(tr => {
        const id = tr.getAttribute("data-id");
        const row = customers.find(x => x.id === id);
        tr.addEventListener("click", ()=> openCustomerEdit(row));
        tr.addEventListener("dblclick",(e)=>{ e.preventDefault(); openCustomerEdit(row); });
      });
    }

    function customerFormHtml(r){
      return `
        <div class="grid2">
          <div><div class="small muted">Nimi</div><input id="f_nimi" value="${escapeHtml(r?.nimi||"")}"></div>
          <div><div class="small muted">Puhelin</div><input id="f_puhelin" value="${escapeHtml(r?.puhelin||"")}"></div>
          <div><div class="small muted">S√§hk√∂posti</div><input id="f_sahkoposti" value="${escapeHtml(r?.sahkoposti||"")}"></div>
          <div>
            <div class="small muted">Poistettu</div>
            <select id="f_poistettu">
              <option value="false" ${r?.poistettu ? "" : "selected"}>false</option>
              <option value="true" ${r?.poistettu ? "selected" : ""}>true</option>
            </select>
          </div>
        </div>
      `;
    }

    function openCustomerAdd(){
      openModal("Lis√§√§ asiakas","",customerFormHtml(null),{table:"customers",mode:"add",row:null});
    }
    function openCustomerEdit(row){
      openModal("Muokkaa asiakas","",customerFormHtml(row),{table:"customers",mode:"edit",row});
    }

    $("custRefresh").onclick = loadCustomers;
    $("custSearch").addEventListener("input", renderCustomers);
    $("custAdd").onclick = openCustomerAdd;

    // ===== Intake (customer pick + free locations) =====
    const ROW_ORDER = { A:1, B:2, C:3, K:4, Y:5 };
    function sortLocations(a,b){
      const sa = Number(a.shelf ?? parseInt(String(a.code||"").match(/^\d+/)?.[0] || "0",10));
      const sb = Number(b.shelf ?? parseInt(String(b.code||"").match(/^\d+/)?.[0] || "0",10));
      if(sa !== sb) return sa - sb;

      const ra = a.row_letter ?? String(a.code||"").replace(/^\d+/,"").slice(0,1);
      const rb = b.row_letter ?? String(b.code||"").replace(/^\d+/,"").slice(0,1);
      const roa = ROW_ORDER[ra] ?? 99;
      const rob = ROW_ORDER[rb] ?? 99;
      if(roa !== rob) return roa - rob;

      const pa = Number(a.spot ?? parseInt(String(a.code||"").match(/[1-8]$/)?.[0] || "0",10));
      const pb = Number(b.spot ?? parseInt(String(b.code||"").match(/[1-8]$/)?.[0] || "0",10));
      return pa - pb;
    }

    async function loadCustomersForPicklist(){
      const hotel_code = $("hotelCode").value.trim();
      const { data, error } = await supabase
        .from("customers")
        .select("id,nimi,puhelin,sahkoposti,poistettu")
        .eq("hotel_code", hotel_code)
        .eq("poistettu", false)
        .order("nimi",{ascending:true});
      if(error){ setStatus("Customers pick: "+error.message, "err"); return; }
      customersActive = data ?? [];
      $("custList").innerHTML = customersActive.map(c => {
        const label = `${c.nimi||""} ‚Ä¢ ${c.puhelin||""} ‚Ä¢ ${c.sahkoposti||""}`.trim();
        // datalist option value must be plain
        return `<option value="${escapeHtml(label)}"></option>`;
      }).join("");
    }

    async function fillFreeLocations(){
      const hotel_code = $("hotelCode").value.trim();

      const { data: used, error: usedErr } = await supabase
        .from("tires")
        .select("hyllypaikka")
        .eq("hotel_code", hotel_code)
        .eq("poistettu", false);
      if(usedErr){ setStatus("Free locations: "+usedErr.message, "err"); return; }
      const usedSet = new Set((used ?? []).map(x => x.hyllypaikka).filter(Boolean));

      const { data: loc, error: locErr } = await supabase
        .from("locations")
        .select("code,label,shelf,row_letter,spot")
        .eq("hotel_code", hotel_code);
      if(locErr){ setStatus("Locations: "+locErr.message, "err"); return; }

      const free = (loc ?? []).filter(l => !usedSet.has(l.code)).sort(sortLocations);
      $("in_hyllypaikka").innerHTML = free.map(l =>
        `<option value="${escapeHtml(l.code)}">${escapeHtml(l.code)} - ${escapeHtml(l.label||"")}</option>`
      ).join("");
    }

    async function loadIntake(){
      const hotel_code = $("hotelCode").value.trim();
      if(!hotel_code){ setStatus("Anna hotel_code.", "err"); return; }
      $("in_today").textContent = "Sis√§√§n: " + new Date().toISOString().slice(0,10);
      $("in_pick_hint").style.display = "none";
      await Promise.all([loadCustomersForPicklist(), fillFreeLocations()]);
      setStatus("Valmis.", "ok");
    }
    $("intakeRefresh").onclick = async () => { await fillFreeLocations(); };

    $("in_customer_pick").addEventListener("change", () => {
      const v = $("in_customer_pick").value || "";
      const norm = v.toLowerCase();
      const c = customersActive.find(x => {
        const s = `${x.nimi||""} ${x.puhelin||""} ${x.sahkoposti||""}`.toLowerCase();
        return s.includes(norm) || norm.includes((x.nimi||"").toLowerCase());
      });
      if(!c) return;
      $("in_nimi").value = c.nimi || "";
      $("in_puhelin").value = c.puhelin || "";
      $("in_sahkoposti").value = c.sahkoposti || "";
      $("in_rekisteri").value = "";
      $("in_rekisteri").focus();
      $("in_pick_hint").style.display = "";
      $("in_pick_hint").textContent = "Asiakas t√§ytetty. T√§yt√§ vain rekisteri.";
    });

    function clearIntake(){
      $("in_customer_pick").value = "";
      $("in_nimi").value = "";
      $("in_puhelin").value = "";
      $("in_sahkoposti").value = "";
      $("in_rekisteri").value = "";
      $("in_pick_hint").style.display = "none";
    }

    $("in_save").onclick = async () => {
      const hotel_code = $("hotelCode").value.trim();
      if(!hotel_code){ setStatus("Anna hotel_code.", "err"); return; }

      const payload = {
        hotel_code,
        nimi: $("in_nimi").value.trim() || null,
        puhelin: $("in_puhelin").value.trim() || null,
        sahkoposti: $("in_sahkoposti").value.trim() || null,
        rekisteri: $("in_rekisteri").value.trim() || null,
        hyllypaikka: $("in_hyllypaikka").value || null,
        sisaan_pvm: new Date().toISOString().slice(0,10),
        tila: "Varastossa",
        poistettu: false,
        season_fee_paid: $("in_maksettu").value, // TEXT: "Maksettu" / "Ei maksettu"
        paivitetty: new Date().toISOString()
      };

      if(!payload.nimi || !payload.rekisteri || !payload.hyllypaikka){
        setStatus("Puuttuu: nimi, rekisteri tai hyllypaikka.", "err");
        return;
      }

      // extra safety: ensure location free
      const { data: conflict, error: cErr } = await supabase
        .from("tires")
        .select("id,rekisteri")
        .eq("hotel_code", hotel_code)
        .eq("hyllypaikka", payload.hyllypaikka)
        .eq("poistettu", false)
        .limit(1);
      if(cErr){ setStatus("Tarkistus: "+cErr.message, "err"); return; }
      if(conflict?.length){
        setStatus(`Hyllypaikka ${payload.hyllypaikka} ei ole vapaa (${conflict[0].rekisteri}). P√§ivit√§ vapaat hyllyt.`, "err");
        return;
      }

      const { error } = await supabase.from("tires").insert(payload);
      if(error){ setStatus("Sis√§√§notto: " + error.message, "err"); return; }

      clearIntake();
      await fillFreeLocations();
      setStatus("Sis√§√§notto tallennettu.", "ok");
    };

    // ===== Tires =====
    let tires = [];
    async function loadTires(){
      const hotel_code = $("hotelCode").value.trim();
      if(!hotel_code){ setStatus("Anna hotel_code.", "err"); return; }
      setStatus("Ladataan renkaat‚Ä¶");
      const { data, error } = await supabase
        .from("tires")
        .select("id,rekisteri,nimi,puhelin,hyllypaikka,tila,sisaan_pvm,poistettu,season_fee_paid,paivitetty")
        .eq("hotel_code", hotel_code)
        .order("paivitetty",{ascending:false});
      if(error){ setStatus("Tires: "+error.message, "err"); return; }
      tires = data ?? [];
      renderTires();
      setStatus("Valmis.", "ok");
    }
    function renderTires(){
      const term = $("tiresSearch").value.trim().toLowerCase();
      const st = $("tiresStatus").value.trim();
      let rows = tires;
      if(st) rows = rows.filter(r => String(r.tila||"") === st);
      if(term) rows = rows.filter(r => `${r.rekisteri||""} ${r.nimi||""} ${r.hyllypaikka||""}`.toLowerCase().includes(term));

      $("tiresTbody").innerHTML = rows.map(r => `
        <tr>
          <td><b>${escapeHtml(r.rekisteri||"")}</b></td>
          <td>${escapeHtml(r.nimi||"")}</td>
          <td>${escapeHtml(r.puhelin||"")}</td>
          <td>${escapeHtml(r.hyllypaikka||"")}</td>
          <td>${escapeHtml(r.tila||"")}</td>
          <td class="small">${escapeHtml(r.sisaan_pvm||"")}</td>
          <td class="small"><span class="pill">${escapeHtml(r.season_fee_paid||"")}</span></td>
        </tr>
      `).join("");
    }
    $("tiresRefresh").onclick = loadTires;
    $("tiresSearch").addEventListener("input", renderTires);
    $("tiresStatus").addEventListener("change", renderTires);

    // ===== Settings =====
    let calSettings = null;
    async function loadSettings(){
      const hotel_code = $("hotelCode").value.trim();
      if(!hotel_code){ setStatus("Anna hotel_code.", "err"); return; }
      setStatus("Ladataan asetukset‚Ä¶");
      const { data, error } = await supabase
        .from("calendar_settings")
        .select("hotel_code,open_time,close_time,slot_minutes,timezone,show_saturday,show_sunday,updated_at")
        .eq("hotel_code", hotel_code)
        .maybeSingle();
      if(error){ setStatus("Settings: "+error.message, "err"); return; }
      calSettings = data ?? null;

      $("setOpen").value = calSettings?.open_time ? String(calSettings.open_time).slice(0,5) : "08:00";
      $("setClose").value = calSettings?.close_time ? String(calSettings.close_time).slice(0,5) : "17:00";
      $("setSlot").value = calSettings?.slot_minutes ?? 20;
      $("setTz").value = calSettings?.timezone ?? "Europe/Helsinki";
      $("setSat").value = String(calSettings?.show_saturday ?? true);
      $("setSun").value = String(calSettings?.show_sunday ?? true);

      setStatus("Valmis.", "ok");
    }

    $("setRefresh").onclick = loadSettings;
    $("setSave").onclick = async () => {
      const hotel_code = $("hotelCode").value.trim();
      if(!hotel_code){ setStatus("Anna hotel_code.", "err"); return; }
      const payload = {
        hotel_code,
        open_time: ($("setOpen").value || "08:00") + ":00",
        close_time: ($("setClose").value || "17:00") + ":00",
        slot_minutes: Number($("setSlot").value || 20),
        timezone: $("setTz").value || "Europe/Helsinki",
        show_saturday: $("setSat").value === "true",
        show_sunday: $("setSun").value === "true",
        updated_at: new Date().toISOString()
      };
      setStatus("Tallennetaan asetukset‚Ä¶");
      const { error } = await supabase.from("calendar_settings").upsert(payload);
      if(error){ setStatus("Save settings: "+error.message, "err"); return; }
      setStatus("Tallennettu.", "ok");
      await loadSettings();
    };

    // ===== Calendar (both bays side-by-side + current week + highlight today) =====
    let appts = [];
    let blocks = [];
    function startOfWeekMonday(date){
      const d = new Date(date);
      const day = (d.getDay()+6)%7; // Mon=0
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - day);
      return d;
    }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function timeToMinutes(hhmm){
      const [h,m] = String(hhmm||"00:00").slice(0,5).split(":").map(Number);
      return (h*60)+(m||0);
    }
    function minutesToHHMM(min){
      const h = Math.floor(min/60);
      const m = min%60;
      return `${pad2(h)}:${pad2(m)}`;
    }
    function sameDay(ts, dayDate){
      const d = new Date(ts);
      return d.getFullYear()===dayDate.getFullYear() && d.getMonth()===dayDate.getMonth() && d.getDate()===dayDate.getDate();
    }
    function startMinute(ts){
      const d = new Date(ts);
      return d.getHours()*60 + d.getMinutes();
    }

    function setCalendarToCurrentWeek(){
      const w = startOfWeekMonday(new Date());
      $("calWeek").value = isoDate(w);
    }
    $("calToday").onclick = async () => { setCalendarToCurrentWeek(); await loadCalendar(); };
    setCalendarToCurrentWeek();

    $("calRefresh").onclick = loadCalendar;
    $("calWeek").addEventListener("change", loadCalendar);

    function apptFormHtml(r, startIso, endIso, bayDefault){
      const bay = bayDefault ?? r?.bay ?? 1;
      return `
        <div class="grid2">
          <div><div class="small muted">Alku (ISO)</div><input id="f_start_ts" value="${escapeHtml(startIso || r?.start_ts || "")}"></div>
          <div><div class="small muted">Loppu (ISO)</div><input id="f_end_ts" value="${escapeHtml(endIso || r?.end_ts || "")}"></div>

          <div><div class="small muted">Rekisteri</div><input id="f_plate" value="${escapeHtml(r?.plate ?? "")}" placeholder="ABC-123"></div>
          <div><div class="small muted">Paikka (bay)</div><input id="f_bay" type="number" min="1" max="2" value="${escapeHtml(bay)}"></div>

          <div><div class="small muted">Asiakas</div><input id="f_customer_name" value="${escapeHtml(r?.customer_name ?? "")}"></div>
          <div><div class="small muted">Puhelin</div><input id="f_phone" value="${escapeHtml(r?.phone ?? "")}"></div>

          <div><div class="small muted">Status</div><input id="f_status" value="${escapeHtml(r?.status ?? "Vahvistettu")}"></div>
          <div class="hint" style="grid-column:1/-1">
            Kun tallennat, rekisteri√§ verrataan varastoon (<span class="k">tires.rekisteri</span>). Jos l√∂ytyy, web tarjoaa nimen/puhelimen t√§ytt√∂√§.
          </div>

          <div style="grid-column:1/-1"><div class="small muted">Muistiinpanot</div><textarea id="f_notes">${escapeHtml(r?.notes ?? "")}</textarea></div>
        </div>
      `;
    }

    function blockFormHtml(r, startIso, endIso){
      return `
        <div class="grid2">
          <div><div class="small muted">Alku (ISO)</div><input id="f_start_ts" value="${escapeHtml(startIso || r?.start_ts || "")}"></div>
          <div><div class="small muted">Loppu (ISO)</div><input id="f_end_ts" value="${escapeHtml(endIso || r?.end_ts || "")}"></div>
          <div><div class="small muted">Kind</div><input id="f_kind" value="${escapeHtml(r?.kind ?? "tauko")}"></div>
          <div><div class="small muted">Title</div><input id="f_title" value="${escapeHtml(r?.title ?? "")}"></div>
          <div style="grid-column:1/-1"><div class="small muted">Notes</div><textarea id="f_notes">${escapeHtml(r?.notes ?? "")}</textarea></div>
        </div>
      `;
    }

    function openApptAddAt(date, hhmm, bay){
      const [h,m]=hhmm.split(":").map(Number);
      const start = new Date(date); start.setHours(h,m,0,0);
      const slot = Number($("setSlot").value || 20);
      const end = new Date(start); end.setMinutes(end.getMinutes()+slot);
      openModal("Uusi varaus","",apptFormHtml(null, start.toISOString(), end.toISOString(), bay),{table:"appointments",mode:"add",row:null});
      setTimeout(()=>{ $("f_plate")?.focus(); },0);
    }
    function openApptEdit(row){
      openModal("Muokkaa varaus","",apptFormHtml(row),{table:"appointments",mode:"edit",row});
    }
    function openBlockAddDefault(){
      const now = new Date();
      now.setMinutes(Math.ceil(now.getMinutes()/20)*20,0,0);
      const end = new Date(now); end.setMinutes(end.getMinutes()+Number($("setSlot").value||20));
      openModal("Uusi blokki","",blockFormHtml(null, now.toISOString(), end.toISOString()),{table:"calendar_blocks",mode:"add",row:null});
    }
    function openBlockEdit(row){
      openModal("Muokkaa blokki","",blockFormHtml(row),{table:"calendar_blocks",mode:"edit",row});
    }

    $("calNewAppt").onclick = () => {
      const weekStart = startOfWeekMonday(new Date($("calWeek").value || new Date()));
      openApptAddAt(weekStart, ($("setOpen").value||"08:00"), 1);
    };
    $("calNewBlock").onclick = openBlockAddDefault;

    async function loadCalendar(){
      const hotel_code = $("hotelCode").value.trim();
      if(!hotel_code){ setStatus("Anna hotel_code.", "err"); return; }

      await loadSettings().catch(()=>{});

      const openHHMM = $("setOpen").value || "08:00";
      const closeHHMM = $("setClose").value || "17:00";
      const slotMin = Number($("setSlot").value || 20);

      const weekStart = startOfWeekMonday(new Date($("calWeek").value || new Date()));
      $("calWeek").value = isoDate(weekStart);

      const showSat = $("setSat").value === "true";
      const showSun = $("setSun").value === "true";
      const days = [0,1,2,3,4,5,6].filter(d => (d<5) || (d===5 && showSat) || (d===6 && showSun));

      const rangeStart = new Date(weekStart); rangeStart.setHours(0,0,0,0);
      const rangeEnd = addDays(rangeStart, 7);

      setStatus("Ladataan kalenteri‚Ä¶");

      const [{data:aData, error:aErr},{data:bData, error:bErr}] = await Promise.all([
        supabase.from("appointments")
          .select("id,hotel_code,start_ts,end_ts,customer_name,phone,plate,notes,status,bay")
          .eq("hotel_code", hotel_code)
          .in("bay", [1,2])
          .gte("start_ts", rangeStart.toISOString())
          .lt("start_ts", rangeEnd.toISOString())
          .order("start_ts",{ascending:true}),
        supabase.from("calendar_blocks")
          .select("id,hotel_code,start_ts,end_ts,kind,title,notes")
          .eq("hotel_code", hotel_code)
          .gte("start_ts", rangeStart.toISOString())
          .lt("start_ts", rangeEnd.toISOString())
          .order("start_ts",{ascending:true})
      ]);

      if(aErr){ setStatus("Appointments: "+aErr.message, "err"); return; }
      if(bErr){ setStatus("Blocks: "+bErr.message, "err"); return; }

      appts = aData ?? [];
      blocks = bData ?? [];

      const dayNames = ["Ma","Ti","Ke","To","Pe","La","Su"];
      const today = new Date(); today.setHours(0,0,0,0);

      $("calThead").innerHTML = `
        <tr>
          <th class="calTime" rowspan="2">Aika</th>
          ${days.map(d => {
            const date = addDays(weekStart, d);
            const isToday = date.getTime() === today.getTime();
            return `<th class="${isToday ? "todayCol":""}" colspan="2">
              ${dayNames[d]} <div class="small muted">${date.toLocaleDateString("fi-FI")}</div>
            </th>`;
          }).join("")}
        </tr>
        <tr>
          ${days.map(d => {
            const date = addDays(weekStart, d);
            const isToday = date.getTime() === today.getTime();
            return `<th class="calCell ${isToday ? "todayCol":""}">Paikka 1</th><th class="calCell ${isToday ? "todayCol":""}">Paikka 2</th>`;
          }).join("")}
        </tr>
      `;

      const openMin = timeToMinutes(openHHMM);
      const closeMin = timeToMinutes(closeHHMM);
      const slots = [];
      for(let m=openMin; m<closeMin; m+=slotMin) slots.push(m);

      // current time row highlight if in this week range
      const now = new Date();
      const nowDay = new Date(now); nowDay.setHours(0,0,0,0);
      const nowMin = now.getHours()*60 + now.getMinutes();
      const nowInWeek = nowDay >= rangeStart && nowDay < rangeEnd;

      $("calHint").textContent =
        `Auki ${openHHMM}‚Äì${closeHHMM}, slot ${slotMin}min. Klikkaa solua ‚Üí uusi varaus siihen paikkaan. Klikkaa pilli√§ ‚Üí muokkaa.`;

      function itemsFor(dayDate, min, bay){
        const dayAppts = appts.filter(a => a.bay===bay && sameDay(a.start_ts, dayDate) && startMinute(a.start_ts)===min);
        const dayBlocks = blocks.filter(b => sameDay(b.start_ts, dayDate) && startMinute(b.start_ts)===min);

        const blockHtml = dayBlocks.map(b =>
          `<div class="pill orange" data-kind="block" data-id="${b.id}">‚õî ${escapeHtml(b.title || b.kind)}</div>`
        ).join("<div style='height:6px'></div>");

        const apptHtml = dayAppts.map(a =>
          `<div class="pill blue" data-kind="appt" data-id="${a.id}">üìÖ ${escapeHtml(a.plate||"")} ‚Ä¢ ${escapeHtml(a.customer_name||"")}</div>`
        ).join("<div style='height:6px'></div>");

        return [blockHtml, apptHtml].filter(Boolean).join("<div style='height:6px'></div>");
      }

      $("calTbody").innerHTML = slots.map(min => {
        const isNowRow = nowInWeek && (Math.abs(min - nowMin) < slotMin/2);
        return `
          <tr class="${isNowRow ? "nowRow":""}">
            <td class="calTimeCell small"><b>${minutesToHHMM(min)}</b></td>
            ${days.map(d => {
              const dayDate = addDays(weekStart, d);
              const isToday = dayDate.getTime() === today.getTime();
              const c1 = itemsFor(dayDate, min, 1);
              const c2 = itemsFor(dayDate, min, 2);
              return `
                <td class="calCell ${isToday ? "todayCol":""}" data-day="${d}" data-min="${min}" data-bay="1">${c1||""}</td>
                <td class="calCell ${isToday ? "todayCol":""}" data-day="${d}" data-min="${min}" data-bay="2">${c2||""}</td>
              `;
            }).join("")}
          </tr>
        `;
      }).join("");

      // cell click -> create appointment
      [...$("calTbody").querySelectorAll("td[data-day][data-bay]")].forEach(td => {
        td.addEventListener("click", (e) => {
          if(e.target?.getAttribute?.("data-kind")) return;
          const dayOffset = Number(td.getAttribute("data-day"));
          const min = Number(td.getAttribute("data-min"));
          const bay = Number(td.getAttribute("data-bay"));
          const date = addDays(weekStart, dayOffset);
          openApptAddAt(date, minutesToHHMM(min), bay);
        });
      });

      // pill click -> edit
      [...$("calTbody").querySelectorAll("[data-kind][data-id]")].forEach(el => {
        el.addEventListener("click", (e) => {
          e.stopPropagation();
          const kind = el.getAttribute("data-kind");
          const id = el.getAttribute("data-id");
          if(kind==="appt"){
            const row = appts.find(x => x.id === id);
            if(row) openApptEdit(row);
          } else {
            const row = blocks.find(x => x.id === id);
            if(row) openBlockEdit(row);
          }
        });
      });

      setStatus("Valmis.", "ok");
    }

    // ===== Modal Save/Delete =====
    async function fillFromPlateIfMatch(payload){
      // same logic for calendar: if plate matches tires.rekisteri, offer fill name/phone
      const hotel_code = $("hotelCode").value.trim();
      if(!payload.plate) return payload;

      const { data: tmatch } = await supabase
        .from("tires")
        .select("nimi,puhelin")
        .eq("hotel_code", hotel_code)
        .eq("rekisteri", payload.plate)
        .eq("poistettu", false)
        .limit(1);

      if(tmatch?.length){
        const t = tmatch[0];
        const ok = confirm(`Rekisteri l√∂ytyy varastosta.\nT√§ytet√§√§nk√∂ nimi/puhelin?\n\n${t.nimi||""} / ${t.puhelin||""}`);
        if(ok){
          payload.customer_name = payload.customer_name || t.nimi || payload.customer_name;
          payload.phone = payload.phone || t.puhelin || payload.phone;
        }
      }
      return payload;
    }

    $("formSave").onclick = async () => {
      const hotel_code = $("hotelCode").value.trim();
      if(!hotel_code){ setStatus("Anna hotel_code.", "err"); return; }

      try{
        if(modalCtx.table==="customers"){
          const payload = {
            hotel_code,
            nimi: $("f_nimi").value.trim(),
            puhelin: $("f_puhelin").value.trim() || null,
            sahkoposti: $("f_sahkoposti").value.trim() || null,
            poistettu: $("f_poistettu").value === "true",
            paivitetty: new Date().toISOString()
          };
          if(!payload.nimi) return setStatus("Nimi puuttuu.", "err");

          const q = (modalCtx.mode==="add")
            ? supabase.from("customers").insert(payload)
            : supabase.from("customers").update(payload).eq("id", modalCtx.row.id);

          const { error } = await q;
          if(error) throw error;

          closeModal();
          await loadCustomers();
          return;
        }

        if(modalCtx.table==="appointments"){
          let payload = {
            hotel_code,
            start_ts: $("f_start_ts").value.trim(),
            end_ts: $("f_end_ts").value.trim(),
            plate: $("f_plate").value.trim() || null,
            customer_name: $("f_customer_name").value.trim() || null,
            phone: $("f_phone").value.trim() || null,
            notes: $("f_notes").value || null,
            status: $("f_status").value.trim() || "Vahvistettu",
            bay: Number($("f_bay").value || 1)
          };

          payload = await fillFromPlateIfMatch(payload);

          const q = (modalCtx.mode==="add")
            ? supabase.from("appointments").insert(payload)
            : supabase.from("appointments").update(payload).eq("id", modalCtx.row.id);

          const { error } = await q;
          if(error) throw error;

          closeModal();
          await loadCalendar();
          return;
        }

        if(modalCtx.table==="calendar_blocks"){
          const payload = {
            hotel_code,
            start_ts: $("f_start_ts").value.trim(),
            end_ts: $("f_end_ts").value.trim(),
            kind: $("f_kind").value.trim() || "tauko",
            title: $("f_title").value.trim() || null,
            notes: $("f_notes").value || null
          };

          const q = (modalCtx.mode==="add")
            ? supabase.from("calendar_blocks").insert(payload)
            : supabase.from("calendar_blocks").update(payload).eq("id", modalCtx.row.id);

          const { error } = await q;
          if(error) throw error;

          closeModal();
          await loadCalendar();
          return;
        }

      } catch(e){
        setStatus("Tallennus: " + (e?.message || String(e)), "err");
      }
    };

    $("formDelete").onclick = async () => {
      if(modalCtx.mode!=="edit" || !modalCtx.table || !modalCtx.row) return;
      if(!confirm("Poistetaanko pysyv√§sti?")) return;

      const { error } = await supabase.from(modalCtx.table).delete().eq("id", modalCtx.row.id);
      if(error){ setStatus("Poisto: "+error.message,"err"); return; }
      closeModal();

      if(modalCtx.table==="customers") await loadCustomers();
      if(modalCtx.table==="appointments" || modalCtx.table==="calendar_blocks") await loadCalendar();
    };

    // ===== Boot =====
    async function boot(){
      setStatus("Tarkistetaan sessio‚Ä¶");
      const { data: { session } } = await supabase.auth.getSession();
      if(!session?.user){
        showAuth();
        setStatus("Kirjaudu sis√§√§n.");
        return;
      }
      showApp(session.user);
      setActiveView("customers");
      await refreshCurrentView();
    }

    supabase.auth.onAuthStateChange((_event, session) => {
      if(session?.user) boot();
      else showAuth();
    });

    await boot();
  </script>
</body>
</html>
