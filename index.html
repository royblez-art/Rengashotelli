<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rengashotelli</title>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://xbxmysfxbkcrjsxjtzkz.supabase.co",
  "sb_publishable_8e1s0Fj93ydy900tLpAwHQ_BAfVDGUq"
);

const $ = id => document.getElementById(id);

let hotel_code = "";

async function boot(){
  const { data:{session} } = await supabase.auth.getSession();
  if(!session?.user){
    document.body.innerHTML = `
      <h2>Kirjaudu</h2>
      <input id="email" placeholder="email"><br><br>
      <input id="pass" type="password" placeholder="password"><br><br>
      <button onclick="login()">Kirjaudu</button>
    `;
    return;
  }
  renderApp();
}

window.login = async function(){
  await supabase.auth.signInWithPassword({
    email: $("email").value,
    password: $("pass").value
  });
  boot();
};

function renderApp(){
  document.body.innerHTML = `
    <h2>Rengashotelli</h2>
    Hotel: <input id="hotel"><button onclick="setHotel()">OK</button>
    <hr>
    <button onclick="intake()">Uusi sisäänotto</button>
    <button onclick="loadTires()">Renkaat</button>
    <button onclick="calendar()">Kalenteri</button>
    <div id="content"></div>
  `;
}

window.setHotel = function(){
  hotel_code = $("hotel").value.trim();
  alert("Hotel asetettu: "+hotel_code);
};


// =======================
// SISÄÄNOTTO
// =======================

window.intake = async function(){
  if(!hotel_code) return alert("Aseta hotel_code");

  const { data: used } = await supabase
    .from("tires")
    .select("hyllypaikka")
    .eq("hotel_code", hotel_code)
    .eq("poistettu", false);

  const usedSet = new Set((used||[]).map(x=>x.hyllypaikka));

  const { data: loc } = await supabase
    .from("locations")
    .select("code")
    .eq("hotel_code", hotel_code);

  const free = (loc||[]).filter(l=>!usedSet.has(l.code));

  $("content").innerHTML = `
    <h3>Uusi sisäänotto</h3>
    Nimi <input id="nimi"><br><br>
    Rek <input id="rek"><br><br>
    Puhelin <input id="puh"><br><br>
    S.posti <input id="sposti"><br><br>

    Hyllypaikka
    <select id="hylly">
      ${free.map(f=>`<option>${f.code}</option>`).join("")}
    </select><br><br>

    Kausimaksu
    <select id="maksu">
      <option value="true">Maksettu</option>
      <option value="false">Ei maksettu</option>
    </select><br><br>

    <button onclick="saveIntake()">Tallenna</button>
  `;
};

window.saveIntake = async function(){
  const payload = {
    hotel_code,
    nimi: $("nimi").value,
    rekisteri: $("rek").value,
    puhelin: $("puh").value,
    sahkoposti: $("sposti").value,
    hyllypaikka: $("hylly").value,
    sisaan_pvm: new Date().toISOString().slice(0,10),
    tila: "Varastossa",
    poistettu: false,
    kausimaksu_maksettu: $("maksu").value==="true"
  };

  const { error } = await supabase.from("tires").insert(payload);
  if(error) return alert(error.message);

  alert("Tallennettu");
  loadTires();
};


// =======================
// RENKAAT
// =======================

window.loadTires = async function(){
  const { data } = await supabase
    .from("tires")
    .select("*")
    .eq("hotel_code", hotel_code)
    .eq("poistettu", false)
    .order("paivitetty",{ascending:false});

  $("content").innerHTML = `
    <h3>Renkaat</h3>
    ${data.map(r=>`
      <div style="border:1px solid #ccc;padding:10px;margin:5px;">
        <b>${r.rekisteri}</b> - ${r.nimi} - ${r.hyllypaikka}
      </div>
    `).join("")}
  `;
};


// =======================
// KALENTERI
// =======================

window.calendar = async function(){
  const { data } = await supabase
    .from("appointments")
    .select("*")
    .eq("hotel_code", hotel_code)
    .order("start_ts",{ascending:true});

  $("content").innerHTML = `
    <h3>Varaukset</h3>
    ${data.map(a=>`
      <div style="border:1px solid #ccc;padding:10px;margin:5px;">
        ${a.start_ts} - ${a.customer_name} - ${a.plate}
      </div>
    `).join("")}
  `;
};

boot();
</script>
</head>
<body></body>
</html>
